<!DOCTYPE html>
<!-- saved from url=(0054)https://www.a1k0n.net/2021/01/13/optimizing-donut.html -->
<html>
<head>
    <title>donut.c without a math library – a1k0n.net</title>
</head>

<body class="site" data-new-gr-c-s-check-loaded="14.1024.0" data-gr-ext-installed=""><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div>

	

   <div class="site-wrap">
   <header class="site-header px2 px-responsive">
      <div class="mt2 wrap">
         <div class="measure">
            <a href="https://www.a1k0n.net/" class="site-title">a1k0n.net</a>
            <nav class="site-nav">
               <a href="https://www.a1k0n.net/about.html">About</a>
            </nav>
         </div>
      </div>
   </header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        <div class="post-header mb2">
  <h1>donut.c without a math library</h1>
  <span class="post-meta">Jan 13, 2021</span><br>
  
</div>

<article class="post-content">
  <p>My little <a href="https://www.a1k0n.net/2011/07/20/donut-math.html">donut.c</a> has
 been making the rounds
again, after being featured in a couple YouTube videos (e.g., <a href="https://www.youtube.com/watch?v=DEqXNfs_HhY">Lex
Fridman</a> and <a href="https://www.youtube.com/watch?v=sW9npZVpiMI">Joma
Tech</a>).  If I had known how much
attention this code would get over the years, I would have spent more time on
it.</p>

<p>One thing that’s always been sort of unfortunate is the heavy use of <code class="language-plaintext highlighter-rouge">sin</code> and
<code class="language-plaintext highlighter-rouge">cos</code> – both because it necessitates linking the math library (<code class="language-plaintext highlighter-rouge">-lm</code>), but
also because it makes it much more CPU-intensive than it really needs to be.
This is especially apparent if you try to port it to an <a href="https://twitter.com/chainq/status/1297178062937825280">older
CPU</a> or an <a href="https://twitter.com/enjoy_digital/status/1341095343816118272">embedded
device</a>.</p>

<p>So, here’s a revised version with no use of <code class="language-plaintext highlighter-rouge">sin</code>, <code class="language-plaintext highlighter-rouge">cos</code>, and no need for
linking the math library (though this version still does use <code class="language-plaintext highlighter-rouge">float</code> types).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>             i,j,k,x,y,o,N;
         main(){float z[1760],a
      #define R(t,x,y) f=x;x-=t*y\
   ;y+=t*f;f=(3-x*x-y*y)/2;x*=f;y*=f;
   =0,e=1,c=1,d=0,f,g,h,G,H,A,t,D;char
 b[1760];for(;;){memset(b,32,1760);g=0,
h=1;memset(z,0,7040);for(j=0;j&lt;90;j++){
G=0,H=1;for(i=0;i&lt;314;i++){A=h+2,D=1/(G*
A*a+g*e+5);t=G*A        *e-g*a;x=40+30*D
*(H*A*d-t*c);y=          12+15*D*(H*A*c+
t*d);o=x+80*y;N          =8*((g*a-G*h*e)
*d-G*h*a-g*e-H*h        *c);if(22&gt;y&amp;&amp;y&gt;
 0&amp;&amp;x&gt;0&amp;&amp;80&gt;x&amp;&amp;D&gt;z[o]){z[o]=D;b[o]=(N&gt;0
  ?N:0)[".,-~:;=!*#$@"];}R(.02,H,G);}R(
  .07,h,g);}for(k=0;1761&gt;k;k++)putchar
   (k%80?b[k]:10);R(.04,e,a);R(.02,d,
     c);usleep(15000);printf('\n'+(
        " donut.c! \x1b[23A"));}}
          /*no math lib needed
             .@a1k0n 2021.*/
</code></pre></div></div>

<p>It’s a little misshapen and still has comments at the bottom. I used the first
frame of its output as a template and there’s <em>slightly</em> less code than filled
pixels – oh well. Output is pretty much the same as before:</p>

<pre>                                                                                                                                                              
                                  $@@@@@@@@@@                                  
                              $$$$$##########$$$$$                             
                           $$$$###***!********###$$$$                          
                         $$$###**!!!!!====!!!!!**###$$#                        
                       *#$$###*!!!=;;::::::;==!!!*###$$#*                      
                      *######*!!=;:~-,....,-~:;=!!*######*                     
                     !######**!=;:-.........,-:;=!**######=                    
                     *######**!=;~,..      ..,~;=!*#######*                    
                    =*#######**!;~.          .~;!**#######*;                   
                    =!*########*!=~          ~;!*########*!=                   
                    =!*####$$$###*!;        ;!*###$$$$###*!;                   
                    ;!!*###$$$$$$$###*!  !*##$$$$$$$$###*!=:                   
                     =!**###$$$$$$$$$$$$$$$$$$$$$$$$###*!!=                    
                     :=!!*####$$$$$@@@@@@@@@@@$$$$###**!!=:                    
                      :=!****####$$$$$$$$$$$$$$####***!!=~                     
                       ~;=!*!****###$$$$$$$$###****!!==;-                      
                        ,~;==!!******************!!==:~                        
                          .~:;==!!!!******!*!!!!=;;:-                          
                             ,~~:;;;;======;;;;:~-.                            
</pre>

<h1 id="defining-a-rotation">Defining a rotation</h1>

<p>So, how do we get sines and cosines without using <code class="language-plaintext highlighter-rouge">sin</code> and <code class="language-plaintext highlighter-rouge">cos</code>? Well, the
code doesn’t really <em>need</em> sine and cosine <em>per se</em>; what it actually does is
rotate a point around the origin in two nested loops, and also rotate two
angles just for the animation. If you’ll recall from the other article, the
inner loop is just plotting dots in a circle, which goes around another, larger
circle. In each loop, the sine/cosine terms are just moving by a small, fixed
angle.</p>

<p>So we don’t need to track the <em>angle</em> at all, we only need to start at cos=1,
sin=0 and rotate a circle around the origin to generate all the sines and
cosines we need. We just have to repeatedly apply a fixed rotation matrix:</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-1-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mrow&gt;&lt;mo&gt;[&lt;/mo&gt;&lt;mtable rowspacing=&quot;4pt&quot; columnspacing=&quot;1em&quot;&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;msup&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mo&gt;&amp;#x2032;&lt;/mo&gt;&lt;/msup&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;msup&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;&amp;#x2032;&lt;/mo&gt;&lt;/msup&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;/mtable&gt;&lt;mo&gt;]&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mrow&gt;&lt;mo&gt;[&lt;/mo&gt;&lt;mtable rowspacing=&quot;4pt&quot; columnspacing=&quot;1em&quot;&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;mi&gt;cos&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/mtd&gt;&lt;mtd&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;sin&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;mi&gt;sin&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/mtd&gt;&lt;mtd&gt;&lt;mi&gt;cos&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;/mtable&gt;&lt;mo&gt;]&lt;/mo&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mo&gt;[&lt;/mo&gt;&lt;mtable rowspacing=&quot;4pt&quot; columnspacing=&quot;1em&quot;&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;/mtable&gt;&lt;mo&gt;]&lt;/mo&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1" style="width: 16.096em; display: inline-block;"><span style="display: inline-block; position: relative; width: 12.58em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.838em, 1012.35em, 4.455em, -999.998em); top: -3.396em; left: 0em;"><span class="mrow" id="MathJax-Span-2"><span class="mrow" id="MathJax-Span-3"><span class="mo" id="MathJax-Span-4" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">[</span></span><span class="mtable" id="MathJax-Span-5" style="padding-right: 0.158em; padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 0.744em; height: 0px;"><span style="position: absolute; clip: rect(2.463em, 1000.74em, 4.846em, -999.998em); top: -3.982em; left: 0em;"><span style="display: inline-block; position: relative; width: 0.744em; height: 0px;"><span style="position: absolute; clip: rect(3.127em, 1000.71em, 4.104em, -999.998em); top: -4.646em; left: 50%; margin-left: -0.35em;"><span class="mtd" id="MathJax-Span-6"><span class="mrow" id="MathJax-Span-7"><span class="msup" id="MathJax-Span-8"><span style="display: inline-block; position: relative; width: 0.705em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-9" style="font-family: MathJax_Math-italic;">c</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.432em;"><span class="mo" id="MathJax-Span-10" style="font-size: 70.7%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.127em, 1000.74em, 4.104em, -999.998em); top: -3.24em; left: 50%; margin-left: -0.35em;"><span class="mtd" id="MathJax-Span-11"><span class="mrow" id="MathJax-Span-12"><span class="msup" id="MathJax-Span-13"><span style="display: inline-block; position: relative; width: 0.744em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-14" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.471em;"><span class="mo" id="MathJax-Span-15" style="font-size: 70.7%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-16" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">]</span></span></span><span class="mo" id="MathJax-Span-17" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mrow" id="MathJax-Span-18" style="padding-left: 0.275em;"><span class="mo" id="MathJax-Span-19" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">[</span></span><span class="mtable" id="MathJax-Span-20" style="padding-right: 0.158em; padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 5.744em; height: 0px;"><span style="position: absolute; clip: rect(2.502em, 1001.96em, 4.846em, -999.998em); top: -3.982em; left: 0em;"><span style="display: inline-block; position: relative; width: 1.955em; height: 0px;"><span style="position: absolute; clip: rect(3.166em, 1001.96em, 4.104em, -999.998em); top: -4.646em; left: 50%; margin-left: -0.975em;"><span class="mtd" id="MathJax-Span-21"><span class="mrow" id="MathJax-Span-22"><span class="mi" id="MathJax-Span-23" style="font-family: MathJax_Main;">cos</span><span class="mo" id="MathJax-Span-24"></span><span class="mi" id="MathJax-Span-25" style="font-family: MathJax_Math-italic; padding-left: 0.158em;">θ</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.166em, 1001.84em, 4.104em, -999.998em); top: -3.24em; left: 50%; margin-left: -0.936em;"><span class="mtd" id="MathJax-Span-32"><span class="mrow" id="MathJax-Span-33"><span class="mi" id="MathJax-Span-34" style="font-family: MathJax_Main;">sin</span><span class="mo" id="MathJax-Span-35"></span><span class="mi" id="MathJax-Span-36" style="font-family: MathJax_Math-italic; padding-left: 0.158em;">θ</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(2.502em, 1002.77em, 4.846em, -999.998em); top: -3.982em; left: 2.971em;"><span style="display: inline-block; position: relative; width: 2.775em; height: 0px;"><span style="position: absolute; clip: rect(3.166em, 1002.77em, 4.182em, -999.998em); top: -4.646em; left: 50%; margin-left: -1.404em;"><span class="mtd" id="MathJax-Span-26"><span class="mrow" id="MathJax-Span-27"><span class="mo" id="MathJax-Span-28" style="font-family: MathJax_Main;">−</span><span class="mi" id="MathJax-Span-29" style="font-family: MathJax_Main; padding-left: 0.158em;">sin</span><span class="mo" id="MathJax-Span-30"></span><span class="mi" id="MathJax-Span-31" style="font-family: MathJax_Math-italic; padding-left: 0.158em;">θ</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.166em, 1001.96em, 4.104em, -999.998em); top: -3.24em; left: 50%; margin-left: -0.975em;"><span class="mtd" id="MathJax-Span-37"><span class="mrow" id="MathJax-Span-38"><span class="mi" id="MathJax-Span-39" style="font-family: MathJax_Main;">cos</span><span class="mo" id="MathJax-Span-40"></span><span class="mi" id="MathJax-Span-41" style="font-family: MathJax_Math-italic; padding-left: 0.158em;">θ</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-42" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">]</span></span></span><span class="mrow" id="MathJax-Span-43" style="padding-left: 0.158em;"><span class="mo" id="MathJax-Span-44" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">[</span></span><span class="mtable" id="MathJax-Span-45" style="padding-right: 0.158em; padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 0.471em; height: 0px;"><span style="position: absolute; clip: rect(2.775em, 1000.43em, 4.846em, -999.998em); top: -3.982em; left: 0em;"><span style="display: inline-block; position: relative; width: 0.471em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -4.646em; left: 50%; margin-left: -0.232em;"><span class="mtd" id="MathJax-Span-46"><span class="mrow" id="MathJax-Span-47"><span class="mi" id="MathJax-Span-48" style="font-family: MathJax_Math-italic;">c</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.24em; left: 50%; margin-left: -0.232em;"><span class="mtd" id="MathJax-Span-49"><span class="mrow" id="MathJax-Span-50"><span class="mi" id="MathJax-Span-51" style="font-family: MathJax_Math-italic;">s</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-52" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">]</span></span></span></span><span style="display: inline-block; width: 0px; height: 3.4em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.248em; border-left: 0px solid; width: 0px; height: 3.152em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mrow><mo>[</mo><mtable rowspacing="4pt" columnspacing="1em"><mtr><mtd><msup><mi>c</mi><mo>′</mo></msup></mtd></mtr><mtr><mtd><msup><mi>s</mi><mo>′</mo></msup></mtd></mtr></mtable><mo>]</mo></mrow><mo>=</mo><mrow><mo>[</mo><mtable rowspacing="4pt" columnspacing="1em"><mtr><mtd><mi>cos</mi><mo>⁡</mo><mi>θ</mi></mtd><mtd><mo>−</mo><mi>sin</mi><mo>⁡</mo><mi>θ</mi></mtd></mtr><mtr><mtd><mi>sin</mi><mo>⁡</mo><mi>θ</mi></mtd><mtd><mi>cos</mi><mo>⁡</mo><mi>θ</mi></mtd></mtr></mtable><mo>]</mo></mrow><mrow><mo>[</mo><mtable rowspacing="4pt" columnspacing="1em"><mtr><mtd><mi>c</mi></mtd></mtr><mtr><mtd><mi>s</mi></mtd></mtr></mtable><mo>]</mo></mrow></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-1">\begin{bmatrix}
c' \\
s'
\end{bmatrix} = \begin{bmatrix}
\cos \theta & -\sin \theta \\
\sin \theta & \cos \theta
\end{bmatrix} \begin{bmatrix} c \\ s \end{bmatrix}</script>

<p>So for example, if we were to use an angle of .02 radians in our inner loop, it would look something like:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>  <span class="c1">// c for cos, s for sin</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">314</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// 314 * .02 ~= 2π</span>
  <span class="c1">// (use c, s in code)</span>
  <span class="kt">float</span> <span class="n">newc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">9998</span><span class="o">*</span><span class="n">c</span> <span class="o">-</span> <span class="mi">0</span><span class="p">.</span><span class="mo">01</span><span class="mi">9998666</span><span class="o">*</span><span class="n">s</span><span class="p">;</span>
  <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mo">01</span><span class="mi">9998666</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="mi">0</span><span class="p">.</span><span class="mi">9998</span><span class="o">*</span><span class="n">s</span><span class="p">;</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">newc</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="renormalizing">Renormalizing</h1>

<p>That works, but there’s a problem: no matter how precisely we define our
constants, after repeated iteration of this procedure, the magnitude of our <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-2-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-53" style="width: 2.697em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.111em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.408em, 1002.03em, 2.619em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-54"><span class="mrow" id="MathJax-Span-55"><span class="mo" id="MathJax-Span-56" style="font-family: MathJax_Main;">(</span><span class="mrow" id="MathJax-Span-57"><span class="mi" id="MathJax-Span-58" style="font-family: MathJax_Math-italic;">c</span><span class="mo" id="MathJax-Span-59" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-60" style="font-family: MathJax_Math-italic; padding-left: 0.158em;">s</span></span><span class="mo" id="MathJax-Span-61" style="font-family: MathJax_Main;">)</span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.403em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><mo>(</mo><mrow><mi>c</mi><mo>,</mo><mi>s</mi></mrow><mo>)</mo></mrow></math></span></span><script type="math/tex" id="MathJax-Element-2">\left(c, s\right)</script> vector will exponentially grow or shrink over time. If we
only need to make one pass around the loop, maybe we can get away with that,
but if we have to make several (for the rotating animation, we do), we need to
fix that.</p>

<p><img src="./donut.c without a math library – a1k0n.net_files/sincos-mag.png" alt="sine and cosine magnitude creep"><br>
<em>an exaggerated illustration of what happens when repeatedly doing low-precision rotations</em></p>

<p>The simplest way to do that would be to multiply <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-3-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-62" style="width: 0.549em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.432em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.721em, 1000.43em, 2.385em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-63"><span class="mi" id="MathJax-Span-64" style="font-family: MathJax_Math-italic;">c</span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.048em; border-left: 0px solid; width: 0px; height: 0.703em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>c</mi></math></span></span><script type="math/tex" id="MathJax-Element-3">c</script> and <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-4-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-65" style="width: 0.627em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.721em, 1000.43em, 2.385em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-66"><span class="mi" id="MathJax-Span-67" style="font-family: MathJax_Math-italic;">s</span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.048em; border-left: 0px solid; width: 0px; height: 0.703em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>s</mi></math></span></span><script type="math/tex" id="MathJax-Element-4">s</script> by <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-5-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo&gt;/&lt;/mo&gt;&lt;/mrow&gt;&lt;msqrt&gt;&lt;msup&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;/msqrt&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-68" style="width: 6.252em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.885em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.291em, 1004.88em, 2.619em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-69"><span class="mn" id="MathJax-Span-70" style="font-family: MathJax_Main;">1</span><span class="texatom" id="MathJax-Span-71"><span class="mrow" id="MathJax-Span-72"><span class="mo" id="MathJax-Span-73" style="font-family: MathJax_Main;">/</span></span></span><span class="msqrt" id="MathJax-Span-74"><span style="display: inline-block; position: relative; width: 3.869em; height: 0px;"><span style="position: absolute; clip: rect(3.127em, 1003.01em, 4.182em, -999.998em); top: -3.982em; left: 0.822em;"><span class="mrow" id="MathJax-Span-75"><span class="msubsup" id="MathJax-Span-76"><span style="display: inline-block; position: relative; width: 0.861em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-77" style="font-family: MathJax_Math-italic;">c</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.256em; left: 0.432em;"><span class="mn" id="MathJax-Span-78" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-79" style="font-family: MathJax_Main; padding-left: 0.236em;">+</span><span class="msubsup" id="MathJax-Span-80" style="padding-left: 0.236em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-81" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.256em; left: 0.471em;"><span class="mn" id="MathJax-Span-82" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.596em, 1003.05em, 3.869em, -999.998em); top: -4.568em; left: 0.822em;"><span style="display: inline-block; position: relative; width: 3.049em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -3.982em; left: -0.076em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -3.982em; left: 2.346em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -3.982em; left: 0.393em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -3.982em; left: 0.861em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -3.982em; left: 1.369em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -3.982em; left: 1.838em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.088em, 1000.86em, 4.299em, -999.998em); top: -4.061em; left: 0em;"><span style="font-family: MathJax_Main;">√</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.502em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>1</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><msqrt><msup><mi>c</mi><mn>2</mn></msup><mo>+</mo><msup><mi>s</mi><mn>2</mn></msup></msqrt></math></span></span><script type="math/tex" id="MathJax-Element-5">1/\sqrt{c^2 + s^2}</script>, but then we’re back to using the math library again. Instead, we can take
advantage of the fact that our magnitude starts out very close to 1, and we’re
going to be iterating this procedure: we can do a <a href="https://en.wikipedia.org/wiki/Newton%27s_method">Newton
step</a> after each rotation, and
that will be enough to keep the magnitude “close enough” to 1 over time.</p>

<p>Our goal is to find the reciprocal square root (<a href="https://en.wikipedia.org/wiki/Fast_inverse_square_root">sound
familiar?</a>) of <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-6-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-83" style="width: 6.252em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.885em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.33em, 1004.88em, 2.463em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-84"><span class="mi" id="MathJax-Span-85" style="font-family: MathJax_Math-italic;">a</span><span class="mo" id="MathJax-Span-86" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="msubsup" id="MathJax-Span-87" style="padding-left: 0.275em;"><span style="display: inline-block; position: relative; width: 0.861em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-88" style="font-family: MathJax_Math-italic;">c</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.432em;"><span class="mn" id="MathJax-Span-89" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-90" style="font-family: MathJax_Main; padding-left: 0.236em;">+</span><span class="msubsup" id="MathJax-Span-91" style="padding-left: 0.236em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-92" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.471em;"><span class="mn" id="MathJax-Span-93" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.148em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>a</mi><mo>=</mo><msup><mi>c</mi><mn>2</mn></msup><mo>+</mo><msup><mi>s</mi><mn>2</mn></msup></math></span></span><script type="math/tex" id="MathJax-Element-6">a =
c^2 + s^2</script>, our <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-7-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-94" style="width: 2.697em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.111em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.408em, 1002.03em, 2.619em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-95"><span class="mrow" id="MathJax-Span-96"><span class="mo" id="MathJax-Span-97" style="font-family: MathJax_Main;">(</span><span class="mrow" id="MathJax-Span-98"><span class="mi" id="MathJax-Span-99" style="font-family: MathJax_Math-italic;">c</span><span class="mo" id="MathJax-Span-100" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-101" style="font-family: MathJax_Math-italic; padding-left: 0.158em;">s</span></span><span class="mo" id="MathJax-Span-102" style="font-family: MathJax_Main;">)</span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.403em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><mo>(</mo><mrow><mi>c</mi><mo>,</mo><mi>s</mi></mrow><mo>)</mo></mrow></math></span></span><script type="math/tex" id="MathJax-Element-7">\left(c, s\right)</script> vector magnitude.  Say we define a
function <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-8-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;msup&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;/mfrac&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-103" style="width: 7.814em; display: inline-block;"><span style="display: inline-block; position: relative; width: 6.096em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.291em, 1006.06em, 2.814em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-104"><span class="mi" id="MathJax-Span-105" style="font-family: MathJax_Math-italic;">f<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.08em;"></span></span><span class="mo" id="MathJax-Span-106" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-107" style="font-family: MathJax_Math-italic;">x</span><span class="mo" id="MathJax-Span-108" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-109" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mfrac" id="MathJax-Span-110" style="padding-left: 0.275em;"><span style="display: inline-block; position: relative; width: 0.822em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.4em, 1000.31em, 4.104em, -999.998em); top: -4.373em; left: 50%; margin-left: -0.193em;"><span class="mn" id="MathJax-Span-111" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.322em, 1000.71em, 4.104em, -999.998em); top: -3.553em; left: 50%; margin-left: -0.35em;"><span class="msubsup" id="MathJax-Span-112"><span style="display: inline-block; position: relative; width: 0.705em; height: 0px;"><span style="position: absolute; clip: rect(3.557em, 1000.35em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-113" style="font-size: 70.7%; font-family: MathJax_Math-italic;">x</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.178em; left: 0.393em;"><span class="mn" id="MathJax-Span-114" style="font-size: 50%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1000.82em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 0.822em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span><span class="mo" id="MathJax-Span-115" style="font-family: MathJax_Main; padding-left: 0.236em;">−</span><span class="mi" id="MathJax-Span-116" style="font-family: MathJax_Math-italic; padding-left: 0.236em;">a</span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.597em; border-left: 0px solid; width: 0px; height: 1.752em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><msup><mi>x</mi><mn>2</mn></msup></mfrac><mo>−</mo><mi>a</mi></math></span></span><script type="math/tex" id="MathJax-Element-8">f(x) = \frac{1}{x^2} - a</script>. The function is 0 when <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-9-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;msqrt&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;/msqrt&gt;&lt;/mfrac&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-117" style="width: 4.104em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.205em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.291em, 1003.21em, 2.971em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-118"><span class="mi" id="MathJax-Span-119" style="font-family: MathJax_Math-italic;">x</span><span class="mo" id="MathJax-Span-120" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mfrac" id="MathJax-Span-121" style="padding-left: 0.275em;"><span style="display: inline-block; position: relative; width: 1.096em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.4em, 1000.31em, 4.104em, -999.998em); top: -4.373em; left: 50%; margin-left: -0.193em;"><span class="mn" id="MathJax-Span-122" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.361em, 1000.98em, 4.299em, -999.998em); top: -3.592em; left: 50%; margin-left: -0.467em;"><span class="msqrt" id="MathJax-Span-123"><span style="display: inline-block; position: relative; width: 0.979em; height: 0px;"><span style="position: absolute; clip: rect(3.557em, 1000.35em, 4.104em, -999.998em); top: -3.982em; left: 0.588em;"><span class="mrow" id="MathJax-Span-124"><span class="mi" id="MathJax-Span-125" style="font-size: 70.7%; font-family: MathJax_Math-italic;">a</span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.979em, 1000.39em, 1.213em, -999.998em); top: -1.6em; left: 0.588em;"><span style="display: inline-block; overflow: hidden; vertical-align: -0.037em; border-top: 1.3px solid; width: 0.393em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span><span style="position: absolute; clip: rect(3.322em, 1000.59em, 4.26em, -999.998em); top: -3.943em; left: 0em;"><span><span style="font-size: 70.7%; font-family: MathJax_Main;">√</span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1001.1em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 1.096em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.797em; border-left: 0px solid; width: 0px; height: 1.952em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>x</mi><mo>=</mo><mfrac><mn>1</mn><msqrt><mi>a</mi></msqrt></mfrac></math></span></span><script type="math/tex" id="MathJax-Element-9">x =
\frac{1}{\sqrt{a}}</script>. We can start with an initial guess of 1 for <em>x</em>,
perform a Newton iteration to obtain <em>x’</em>, which will be “closer to”
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-10-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mfrac&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;msqrt&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;/msqrt&gt;&lt;/mfrac&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-126" style="width: 1.721em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.33em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.291em, 1001.33em, 2.971em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-127"><span class="mfrac" id="MathJax-Span-128"><span style="display: inline-block; position: relative; width: 1.096em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.4em, 1000.31em, 4.104em, -999.998em); top: -4.373em; left: 50%; margin-left: -0.193em;"><span class="mn" id="MathJax-Span-129" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.361em, 1000.98em, 4.299em, -999.998em); top: -3.592em; left: 50%; margin-left: -0.467em;"><span class="msqrt" id="MathJax-Span-130"><span style="display: inline-block; position: relative; width: 0.979em; height: 0px;"><span style="position: absolute; clip: rect(3.557em, 1000.35em, 4.104em, -999.998em); top: -3.982em; left: 0.588em;"><span class="mrow" id="MathJax-Span-131"><span class="mi" id="MathJax-Span-132" style="font-size: 70.7%; font-family: MathJax_Math-italic;">a</span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.979em, 1000.39em, 1.213em, -999.998em); top: -1.6em; left: 0.588em;"><span style="display: inline-block; overflow: hidden; vertical-align: -0.037em; border-top: 1.3px solid; width: 0.393em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span><span style="position: absolute; clip: rect(3.322em, 1000.59em, 4.26em, -999.998em); top: -3.943em; left: 0em;"><span><span style="font-size: 70.7%; font-family: MathJax_Main;">√</span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1001.1em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 1.096em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.797em; border-left: 0px solid; width: 0px; height: 1.952em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mfrac><mn>1</mn><msqrt><mi>a</mi></msqrt></mfrac></math></span></span><script type="math/tex" id="MathJax-Element-10">\frac{1}{\sqrt{a}}</script>, the correct value to scale <em>c</em> and <em>s</em> by so that their
magnitude <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-11-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msup&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-133" style="width: 3.869em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.01em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.33em, 1003.01em, 2.463em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-134"><span class="msubsup" id="MathJax-Span-135"><span style="display: inline-block; position: relative; width: 0.861em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-136" style="font-family: MathJax_Math-italic;">c</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.432em;"><span class="mn" id="MathJax-Span-137" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-138" style="font-family: MathJax_Main; padding-left: 0.236em;">+</span><span class="msubsup" id="MathJax-Span-139" style="padding-left: 0.236em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-140" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.471em;"><span class="mn" id="MathJax-Span-141" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.148em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>c</mi><mn>2</mn></msup><mo>+</mo><msup><mi>s</mi><mn>2</mn></msup></math></span></span><script type="math/tex" id="MathJax-Element-11">c^2 + s^2</script> is “close to” 1 again.</p>

<p>A Newton step is defined as <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-12-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msup&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo&gt;&amp;#x2032;&lt;/mo&gt;&lt;/msup&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;msup&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mo&gt;&amp;#x2032;&lt;/mo&gt;&lt;/msup&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-142" style="width: 7.658em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.979em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.057em, 1005.98em, 3.049em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-143"><span class="msup" id="MathJax-Span-144"><span style="display: inline-block; position: relative; width: 0.861em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.51em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-145" style="font-family: MathJax_Math-italic;">x</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.588em;"><span class="mo" id="MathJax-Span-146" style="font-size: 70.7%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-147" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mi" id="MathJax-Span-148" style="font-family: MathJax_Math-italic; padding-left: 0.275em;">x</span><span class="mo" id="MathJax-Span-149" style="font-family: MathJax_Main; padding-left: 0.236em;">−</span><span class="mfrac" id="MathJax-Span-150" style="padding-left: 0.236em;"><span style="display: inline-block; position: relative; width: 1.721em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.322em, 1001.29em, 4.299em, -999.998em); top: -4.529em; left: 50%; margin-left: -0.662em;"><span class="mrow" id="MathJax-Span-151"><span class="mi" id="MathJax-Span-152" style="font-size: 70.7%; font-family: MathJax_Math-italic;">f<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.041em;"></span></span><span class="mo" id="MathJax-Span-153" style="font-size: 70.7%; font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-154" style="font-size: 70.7%; font-family: MathJax_Math-italic;">x</span><span class="mo" id="MathJax-Span-155" style="font-size: 70.7%; font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.283em, 1001.52em, 4.299em, -999.998em); top: -3.514em; left: 50%; margin-left: -0.779em;"><span class="mrow" id="MathJax-Span-156"><span class="msup" id="MathJax-Span-157"><span style="display: inline-block; position: relative; width: 0.627em; height: 0px;"><span style="position: absolute; clip: rect(3.361em, 1000.39em, 4.26em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-158" style="font-size: 70.7%; font-family: MathJax_Math-italic;">f<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.041em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.295em; left: 0.471em;"><span class="mo" id="MathJax-Span-159" style="font-size: 50%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-160" style="font-size: 70.7%; font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-161" style="font-size: 70.7%; font-family: MathJax_Math-italic;">x</span><span class="mo" id="MathJax-Span-162" style="font-size: 70.7%; font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1001.72em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 1.721em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.897em; border-left: 0px solid; width: 0px; height: 2.302em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>x</mi><mo>′</mo></msup><mo>=</mo><mi>x</mi><mo>−</mo><mfrac><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><mrow><msup><mi>f</mi><mo>′</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac></math></span></span><script type="math/tex" id="MathJax-Element-12">x' = x - \frac{f(x)}{f'(x)}</script>. I used
<a href="https://www.sympy.org/">SymPy</a> to do the derivative and simplification and
came up with <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-13-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msup&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo&gt;&amp;#x2032;&lt;/mo&gt;&lt;/msup&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;msup&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/mfrac&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-163" style="width: 7.15em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.588em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(0.9em, 1005.59em, 2.736em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-164"><span class="msup" id="MathJax-Span-165"><span style="display: inline-block; position: relative; width: 0.861em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.51em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-166" style="font-family: MathJax_Math-italic;">x</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.588em;"><span class="mo" id="MathJax-Span-167" style="font-size: 70.7%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-168" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mfrac" id="MathJax-Span-169" style="padding-left: 0.275em;"><span style="display: inline-block; position: relative; width: 3.166em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.283em, 1002.93em, 4.338em, -999.998em); top: -4.607em; left: 50%; margin-left: -1.521em;"><span class="mrow" id="MathJax-Span-170"><span class="mi" id="MathJax-Span-171" style="font-size: 70.7%; font-family: MathJax_Math-italic;">x</span><span class="mrow" id="MathJax-Span-172"><span class="mo" id="MathJax-Span-173" style="vertical-align: 0em;"><span><span style="font-size: 70.7%; font-family: MathJax_Size1;">(</span></span></span><span class="mrow" id="MathJax-Span-174"><span class="mn" id="MathJax-Span-175" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span class="mo" id="MathJax-Span-176" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mi" id="MathJax-Span-177" style="font-size: 70.7%; font-family: MathJax_Math-italic;">a</span><span class="msubsup" id="MathJax-Span-178"><span style="display: inline-block; position: relative; width: 0.705em; height: 0px;"><span style="position: absolute; clip: rect(3.557em, 1000.35em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-179" style="font-size: 70.7%; font-family: MathJax_Math-italic;">x</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.256em; left: 0.393em;"><span class="mn" id="MathJax-Span-180" style="font-size: 50%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span class="mo" id="MathJax-Span-181" style="vertical-align: 0em;"><span><span style="font-size: 70.7%; font-family: MathJax_Size1;">)</span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.4em, 1000.31em, 4.104em, -999.998em); top: -3.631em; left: 50%; margin-left: -0.193em;"><span class="mn" id="MathJax-Span-182" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1003.17em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 3.166em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.497em; border-left: 0px solid; width: 0px; height: 2.152em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>x</mi><mo>′</mo></msup><mo>=</mo><mfrac><mrow><mi>x</mi><mrow><mo>(</mo><mrow><mn>3</mn><mo>−</mo><mi>a</mi><msup><mi>x</mi><mn>2</mn></msup></mrow><mo>)</mo></mrow></mrow><mn>2</mn></mfrac></math></span></span><script type="math/tex" id="MathJax-Element-13">x' = \frac{x\left(3 - a x^2\right)}{2}</script>. Since we’re only doing
one step, we can plug in our initial guess of 1 for <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-14-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-183" style="width: 0.705em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.549em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.721em, 1000.51em, 2.385em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-184"><span class="mi" id="MathJax-Span-185" style="font-family: MathJax_Math-italic;">x</span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.048em; border-left: 0px solid; width: 0px; height: 0.703em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>x</mi></math></span></span><script type="math/tex" id="MathJax-Element-14">x</script> and back-substitute
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-15-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msup&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-186" style="width: 3.869em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.01em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.33em, 1003.01em, 2.463em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-187"><span class="msubsup" id="MathJax-Span-188"><span style="display: inline-block; position: relative; width: 0.861em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-189" style="font-family: MathJax_Math-italic;">c</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.432em;"><span class="mn" id="MathJax-Span-190" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-191" style="font-family: MathJax_Main; padding-left: 0.236em;">+</span><span class="msubsup" id="MathJax-Span-192" style="padding-left: 0.236em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-193" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.471em;"><span class="mn" id="MathJax-Span-194" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.148em; border-left: 0px solid; width: 0px; height: 1.252em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>c</mi><mn>2</mn></msup><mo>+</mo><msup><mi>s</mi><mn>2</mn></msup></math></span></span><script type="math/tex" id="MathJax-Element-15">c^2 + s^2</script> for <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-16-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-195" style="width: 0.705em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.549em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.721em, 1000.51em, 2.385em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-196"><span class="mi" id="MathJax-Span-197" style="font-family: MathJax_Math-italic;">a</span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.048em; border-left: 0px solid; width: 0px; height: 0.703em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>a</mi></math></span></span><script type="math/tex" id="MathJax-Element-16">a</script> to finally get our adjustment: <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-17-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msup&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;mo&gt;&amp;#x2032;&lt;/mo&gt;&lt;/msup&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo&gt;/&lt;/mo&gt;&lt;/mrow&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-198" style="width: 11.174em; display: inline-block;"><span style="display: inline-block; position: relative; width: 8.713em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.33em, 1008.67em, 2.619em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-199"><span class="msup" id="MathJax-Span-200"><span style="display: inline-block; position: relative; width: 0.861em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.51em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-201" style="font-family: MathJax_Math-italic;">x</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.588em;"><span class="mo" id="MathJax-Span-202" style="font-size: 70.7%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-203" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mo" id="MathJax-Span-204" style="font-family: MathJax_Main; padding-left: 0.275em;">(</span><span class="mn" id="MathJax-Span-205" style="font-family: MathJax_Main;">3</span><span class="mo" id="MathJax-Span-206" style="font-family: MathJax_Main; padding-left: 0.236em;">−</span><span class="msubsup" id="MathJax-Span-207" style="padding-left: 0.236em;"><span style="display: inline-block; position: relative; width: 0.861em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-208" style="font-family: MathJax_Math-italic;">c</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.432em;"><span class="mn" id="MathJax-Span-209" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-210" style="font-family: MathJax_Main; padding-left: 0.236em;">−</span><span class="msubsup" id="MathJax-Span-211" style="padding-left: 0.236em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-212" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.471em;"><span class="mn" id="MathJax-Span-213" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-214" style="font-family: MathJax_Main;">)</span><span class="texatom" id="MathJax-Span-215"><span class="mrow" id="MathJax-Span-216"><span class="mo" id="MathJax-Span-217" style="font-family: MathJax_Main;">/</span></span></span><span class="mn" id="MathJax-Span-218" style="font-family: MathJax_Main;">2</span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.502em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>x</mi><mo>′</mo></msup><mo>=</mo><mo stretchy="false">(</mo><mn>3</mn><mo>−</mo><msup><mi>c</mi><mn>2</mn></msup><mo>−</mo><msup><mi>s</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mn>2</mn></math></span></span><script type="math/tex" id="MathJax-Element-17">x' = (3 - c^2 - s^2)/2</script>.</p>

<h1 id="further-simplifying-the-rotation">Further simplifying the rotation</h1>

<p>But now that we don’t have to worry so much about the magnitude of our result
(within limits), we can take another shortcut (I got this idea studying old
<a href="https://en.wikipedia.org/wiki/CORDIC">CORDIC</a> algorithms).  If we divide out
the cosines from our original rotation matrix, we get</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-18-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mrow&gt;&lt;mo&gt;[&lt;/mo&gt;&lt;mtable rowspacing=&quot;4pt&quot; columnspacing=&quot;1em&quot;&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;msup&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mo&gt;&amp;#x2032;&lt;/mo&gt;&lt;/msup&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;msup&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mo&gt;&amp;#x2032;&lt;/mo&gt;&lt;/msup&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;/mtable&gt;&lt;mo&gt;]&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mrow&gt;&lt;mi&gt;cos&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;mrow&gt;&lt;mo&gt;[&lt;/mo&gt;&lt;mtable rowspacing=&quot;4pt&quot; columnspacing=&quot;1em&quot;&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mtd&gt;&lt;mtd&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;tan&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;mi&gt;tan&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/mtd&gt;&lt;mtd&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;/mtable&gt;&lt;mo&gt;]&lt;/mo&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mo&gt;[&lt;/mo&gt;&lt;mtable rowspacing=&quot;4pt&quot; columnspacing=&quot;1em&quot;&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;mtr&gt;&lt;mtd&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;/mtd&gt;&lt;/mtr&gt;&lt;/mtable&gt;&lt;mo&gt;]&lt;/mo&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-219" style="width: 19.533em; display: inline-block;"><span style="display: inline-block; position: relative; width: 15.236em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.838em, 1015em, 4.455em, -999.998em); top: -3.396em; left: 0em;"><span class="mrow" id="MathJax-Span-220"><span class="mrow" id="MathJax-Span-221"><span class="mo" id="MathJax-Span-222" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">[</span></span><span class="mtable" id="MathJax-Span-223" style="padding-right: 0.158em; padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 0.744em; height: 0px;"><span style="position: absolute; clip: rect(2.463em, 1000.74em, 4.846em, -999.998em); top: -3.982em; left: 0em;"><span style="display: inline-block; position: relative; width: 0.744em; height: 0px;"><span style="position: absolute; clip: rect(3.127em, 1000.71em, 4.104em, -999.998em); top: -4.646em; left: 50%; margin-left: -0.35em;"><span class="mtd" id="MathJax-Span-224"><span class="mrow" id="MathJax-Span-225"><span class="msup" id="MathJax-Span-226"><span style="display: inline-block; position: relative; width: 0.705em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-227" style="font-family: MathJax_Math-italic;">c</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.432em;"><span class="mo" id="MathJax-Span-228" style="font-size: 70.7%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.127em, 1000.74em, 4.104em, -999.998em); top: -3.24em; left: 50%; margin-left: -0.35em;"><span class="mtd" id="MathJax-Span-229"><span class="mrow" id="MathJax-Span-230"><span class="msup" id="MathJax-Span-231"><span style="display: inline-block; position: relative; width: 0.744em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-232" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.471em;"><span class="mo" id="MathJax-Span-233" style="font-size: 70.7%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-234" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">]</span></span></span><span class="mo" id="MathJax-Span-235" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mfrac" id="MathJax-Span-236" style="padding-left: 0.275em;"><span style="display: inline-block; position: relative; width: 2.072em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.205em, 1000.43em, 4.104em, -999.998em); top: -4.646em; left: 50%; margin-left: -0.232em;"><span class="mn" id="MathJax-Span-237" style="font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.166em, 1001.96em, 4.104em, -999.998em); top: -3.279em; left: 50%; margin-left: -0.975em;"><span class="mrow" id="MathJax-Span-238"><span class="mi" id="MathJax-Span-239" style="font-family: MathJax_Main;">cos</span><span class="mo" id="MathJax-Span-240"></span><span class="mi" id="MathJax-Span-241" style="font-family: MathJax_Math-italic; padding-left: 0.158em;">θ</span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1002.07em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 2.072em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span><span class="mrow" id="MathJax-Span-242"><span class="mo" id="MathJax-Span-243" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">[</span></span><span class="mtable" id="MathJax-Span-244" style="padding-right: 0.158em; padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 6.096em; height: 0px;"><span style="position: absolute; clip: rect(2.541em, 1002.07em, 4.846em, -999.998em); top: -3.982em; left: 0em;"><span style="display: inline-block; position: relative; width: 2.072em; height: 0px;"><span style="position: absolute; clip: rect(3.205em, 1000.43em, 4.104em, -999.998em); top: -4.646em; left: 50%; margin-left: -0.232em;"><span class="mtd" id="MathJax-Span-245"><span class="mrow" id="MathJax-Span-246"><span class="mn" id="MathJax-Span-247" style="font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.166em, 1002.07em, 4.104em, -999.998em); top: -3.24em; left: 50%; margin-left: -1.053em;"><span class="mtd" id="MathJax-Span-254"><span class="mrow" id="MathJax-Span-255"><span class="mi" id="MathJax-Span-256" style="font-family: MathJax_Main;">tan</span><span class="mo" id="MathJax-Span-257"></span><span class="mi" id="MathJax-Span-258" style="font-family: MathJax_Math-italic; padding-left: 0.158em;">θ</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(2.502em, 1003.01em, 4.846em, -999.998em); top: -3.982em; left: 3.088em;"><span style="display: inline-block; position: relative; width: 3.01em; height: 0px;"><span style="position: absolute; clip: rect(3.166em, 1003.01em, 4.182em, -999.998em); top: -4.646em; left: 50%; margin-left: -1.521em;"><span class="mtd" id="MathJax-Span-248"><span class="mrow" id="MathJax-Span-249"><span class="mo" id="MathJax-Span-250" style="font-family: MathJax_Main;">−</span><span class="mi" id="MathJax-Span-251" style="font-family: MathJax_Main; padding-left: 0.158em;">tan</span><span class="mo" id="MathJax-Span-252"></span><span class="mi" id="MathJax-Span-253" style="font-family: MathJax_Math-italic; padding-left: 0.158em;">θ</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.205em, 1000.43em, 4.104em, -999.998em); top: -3.24em; left: 50%; margin-left: -0.232em;"><span class="mtd" id="MathJax-Span-259"><span class="mrow" id="MathJax-Span-260"><span class="mn" id="MathJax-Span-261" style="font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-262" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">]</span></span></span><span class="mrow" id="MathJax-Span-263" style="padding-left: 0.158em;"><span class="mo" id="MathJax-Span-264" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">[</span></span><span class="mtable" id="MathJax-Span-265" style="padding-right: 0.158em; padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 0.471em; height: 0px;"><span style="position: absolute; clip: rect(2.775em, 1000.43em, 4.846em, -999.998em); top: -3.982em; left: 0em;"><span style="display: inline-block; position: relative; width: 0.471em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -4.646em; left: 50%; margin-left: -0.232em;"><span class="mtd" id="MathJax-Span-266"><span class="mrow" id="MathJax-Span-267"><span class="mi" id="MathJax-Span-268" style="font-family: MathJax_Math-italic;">c</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.24em; left: 50%; margin-left: -0.232em;"><span class="mtd" id="MathJax-Span-269"><span class="mrow" id="MathJax-Span-270"><span class="mi" id="MathJax-Span-271" style="font-family: MathJax_Math-italic;">s</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-272" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">]</span></span></span></span><span style="display: inline-block; width: 0px; height: 3.4em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.248em; border-left: 0px solid; width: 0px; height: 3.152em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mrow><mo>[</mo><mtable rowspacing="4pt" columnspacing="1em"><mtr><mtd><msup><mi>c</mi><mo>′</mo></msup></mtd></mtr><mtr><mtd><msup><mi>s</mi><mo>′</mo></msup></mtd></mtr></mtable><mo>]</mo></mrow><mo>=</mo><mfrac><mn>1</mn><mrow><mi>cos</mi><mo>⁡</mo><mi>θ</mi></mrow></mfrac><mrow><mo>[</mo><mtable rowspacing="4pt" columnspacing="1em"><mtr><mtd><mn>1</mn></mtd><mtd><mo>−</mo><mi>tan</mi><mo>⁡</mo><mi>θ</mi></mtd></mtr><mtr><mtd><mi>tan</mi><mo>⁡</mo><mi>θ</mi></mtd><mtd><mn>1</mn></mtd></mtr></mtable><mo>]</mo></mrow><mrow><mo>[</mo><mtable rowspacing="4pt" columnspacing="1em"><mtr><mtd><mi>c</mi></mtd></mtr><mtr><mtd><mi>s</mi></mtd></mtr></mtable><mo>]</mo></mrow></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-18">\begin{bmatrix}
c' \\
s'
\end{bmatrix} = \frac{1}{\cos \theta}\begin{bmatrix}
1 & -\tan \theta \\
\tan \theta & 1
\end{bmatrix} \begin{bmatrix} c \\ s \end{bmatrix}</script>

<p>using the trig identity <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-19-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;tan&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mi&gt;sin&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mi&gt;cos&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-273" style="width: 6.682em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.197em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.252em, 1005.2em, 2.775em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-274"><span class="mi" id="MathJax-Span-275" style="font-family: MathJax_Main;">tan</span><span class="mo" id="MathJax-Span-276"></span><span class="mi" id="MathJax-Span-277" style="font-family: MathJax_Math-italic; padding-left: 0.158em;">θ</span><span class="mo" id="MathJax-Span-278" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mfrac" id="MathJax-Span-279" style="padding-left: 0.275em;"><span style="display: inline-block; position: relative; width: 1.564em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.361em, 1001.37em, 4.104em, -999.998em); top: -4.373em; left: 50%; margin-left: -0.662em;"><span class="mrow" id="MathJax-Span-280"><span class="mi" id="MathJax-Span-281" style="font-size: 70.7%; font-family: MathJax_Main;">sin</span><span class="mo" id="MathJax-Span-282" style="font-size: 70.7%;"></span><span class="mi" id="MathJax-Span-283" style="font-size: 70.7%; font-family: MathJax_Math-italic; padding-left: 0.236em;">θ</span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.361em, 1001.45em, 4.104em, -999.998em); top: -3.592em; left: 50%; margin-left: -0.701em;"><span class="mrow" id="MathJax-Span-284"><span class="mi" id="MathJax-Span-285" style="font-size: 70.7%; font-family: MathJax_Main;">cos</span><span class="mo" id="MathJax-Span-286" style="font-size: 70.7%;"></span><span class="mi" id="MathJax-Span-287" style="font-size: 70.7%; font-family: MathJax_Math-italic; padding-left: 0.236em;">θ</span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1001.56em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 1.564em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.547em; border-left: 0px solid; width: 0px; height: 1.752em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>tan</mi><mo>⁡</mo><mi>θ</mi><mo>=</mo><mfrac><mrow><mi>sin</mi><mo>⁡</mo><mi>θ</mi></mrow><mrow><mi>cos</mi><mo>⁡</mo><mi>θ</mi></mrow></mfrac></math></span></span><script type="math/tex" id="MathJax-Element-19">\tan \theta = \frac{\sin \theta}{\cos \theta}</script>.
Since we’re only dealing with small angles, the leading <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-20-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mfrac&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mrow&gt;&lt;mi&gt;cos&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-288" style="width: 2.307em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.799em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.291em, 1001.8em, 2.775em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-289"><span class="mfrac" id="MathJax-Span-290"><span style="display: inline-block; position: relative; width: 1.564em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.4em, 1000.31em, 4.104em, -999.998em); top: -4.373em; left: 50%; margin-left: -0.193em;"><span class="mn" id="MathJax-Span-291" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.361em, 1001.45em, 4.104em, -999.998em); top: -3.592em; left: 50%; margin-left: -0.701em;"><span class="mrow" id="MathJax-Span-292"><span class="mi" id="MathJax-Span-293" style="font-size: 70.7%; font-family: MathJax_Main;">cos</span><span class="mo" id="MathJax-Span-294" style="font-size: 70.7%;"></span><span class="mi" id="MathJax-Span-295" style="font-size: 70.7%; font-family: MathJax_Math-italic; padding-left: 0.236em;">θ</span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1001.56em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 1.564em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.547em; border-left: 0px solid; width: 0px; height: 1.702em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mfrac><mn>1</mn><mrow><mi>cos</mi><mo>⁡</mo><mi>θ</mi></mrow></mfrac></math></span></span><script type="math/tex" id="MathJax-Element-20">\frac{1}{\cos
\theta}</script> term is close enough to 1 that we can ignore it and have our Newton
step take care of it.</p>

<p>And now we can finally understand how the rotation is done in the code. Towards
the top of the donut code is this #define, which I’ve reindented:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define R(t,x,y) \ 
</span>  <span class="n">f</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span> \
  <span class="n">x</span> <span class="o">-=</span> <span class="n">t</span><span class="o">*</span><span class="n">y</span><span class="p">;</span> \
  <span class="n">y</span> <span class="o">+=</span> <span class="n">t</span><span class="o">*</span><span class="n">f</span><span class="p">;</span> \
  <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> \
  <span class="n">x</span> <span class="o">*=</span> <span class="n">f</span><span class="p">;</span> \
  <span class="n">y</span> <span class="o">*=</span> <span class="n">f</span><span class="p">;</span>
</code></pre></div></div>

<p>This does an in-place rotation of a unit vector <code class="language-plaintext highlighter-rouge">x, y</code> where <code class="language-plaintext highlighter-rouge">t</code> is <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-21-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;tan&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-296" style="width: 2.658em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.072em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.447em, 1002.07em, 2.385em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-297"><span class="mi" id="MathJax-Span-298" style="font-family: MathJax_Main;">tan</span><span class="mo" id="MathJax-Span-299"></span><span class="mi" id="MathJax-Span-300" style="font-family: MathJax_Math-italic; padding-left: 0.158em;">θ</span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.048em; border-left: 0px solid; width: 0px; height: 1.002em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>tan</mi><mo>⁡</mo><mi>θ</mi></math></span></span><script type="math/tex" id="MathJax-Element-21">\tan
\theta</script>. <code class="language-plaintext highlighter-rouge">f</code> is a temporary variable; the first three lines do the “matrix
multiplication” on <code class="language-plaintext highlighter-rouge">x, y</code>. <code class="language-plaintext highlighter-rouge">f</code> is then re-used to get the magnitude adjustment,
and then finally <code class="language-plaintext highlighter-rouge">x</code> and <code class="language-plaintext highlighter-rouge">y</code> are multiplied by <code class="language-plaintext highlighter-rouge">f</code> which moves them back onto
the unit circle.</p>

<p>With that operation in hand, I just replaced all the angles with their sines
and cosines and ran the rotation operator <code class="language-plaintext highlighter-rouge">R()</code> instead of calling <code class="language-plaintext highlighter-rouge">sin</code>/<code class="language-plaintext highlighter-rouge">cos</code>.
The code is otherwise identical.</p>

<h1 id="getting-rid-of-float-too">Getting rid of <code class="language-plaintext highlighter-rouge">float</code>, too</h1>

<p>We can use exactly the same ideas with integer fixed-point arithmetic, and not
use any <code class="language-plaintext highlighter-rouge">float</code> math whatsoever. I’ve redone all the math with 10-bit precision
and produced the following C code which runs well on embedded devices which can
do 32-bit multiplications and have ~4k of available RAM:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdint.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="cp">#define R(mul,shift,x,y) \
  _=x; \
  x -= mul*y&gt;&gt;shift; \
  y += mul*_&gt;&gt;shift; \
  _ = 3145728-x*x-y*y&gt;&gt;11; \
  x = x*_&gt;&gt;10; \
  y = y*_&gt;&gt;10;
</span>
<span class="kt">int8_t</span> <span class="n">b</span><span class="p">[</span><span class="mi">1760</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">1760</span><span class="p">];</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">sA</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span><span class="n">cA</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sB</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span><span class="n">cB</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">_</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1760</span><span class="p">);</span>  <span class="c1">// text buffer</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1760</span><span class="p">);</span>   <span class="c1">// z buffer</span>
    <span class="kt">int</span> <span class="n">sj</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cj</span><span class="o">=</span><span class="mi">1024</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">si</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ci</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>  <span class="c1">// sine and cosine of angle i</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">324</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">R1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">R2</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span> <span class="n">K2</span> <span class="o">=</span> <span class="mi">5120</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>

        <span class="kt">int</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">R1</span><span class="o">*</span><span class="n">cj</span> <span class="o">+</span> <span class="n">R2</span><span class="p">,</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">ci</span><span class="o">*</span><span class="n">x0</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">cA</span><span class="o">*</span><span class="n">sj</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">x3</span> <span class="o">=</span> <span class="n">si</span><span class="o">*</span><span class="n">x0</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">x4</span> <span class="o">=</span> <span class="n">R1</span><span class="o">*</span><span class="n">x2</span> <span class="o">-</span> <span class="p">(</span><span class="n">sA</span><span class="o">*</span><span class="n">x3</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">),</span>
            <span class="n">x5</span> <span class="o">=</span> <span class="n">sA</span><span class="o">*</span><span class="n">sj</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">x6</span> <span class="o">=</span> <span class="n">K2</span> <span class="o">+</span> <span class="n">R1</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="n">x5</span> <span class="o">+</span> <span class="n">cA</span><span class="o">*</span><span class="n">x3</span><span class="p">,</span>
            <span class="n">x7</span> <span class="o">=</span> <span class="n">cj</span><span class="o">*</span><span class="n">si</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">40</span> <span class="o">+</span> <span class="mi">30</span><span class="o">*</span><span class="p">(</span><span class="n">cB</span><span class="o">*</span><span class="n">x1</span> <span class="o">-</span> <span class="n">sB</span><span class="o">*</span><span class="n">x4</span><span class="p">)</span><span class="o">/</span><span class="n">x6</span><span class="p">,</span>
            <span class="n">y</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">15</span><span class="o">*</span><span class="p">(</span><span class="n">cB</span><span class="o">*</span><span class="n">x4</span> <span class="o">+</span> <span class="n">sB</span><span class="o">*</span><span class="n">x1</span><span class="p">)</span><span class="o">/</span><span class="n">x6</span><span class="p">,</span>
            <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">cA</span><span class="o">*</span><span class="n">x7</span> <span class="o">-</span> <span class="n">cB</span><span class="o">*</span><span class="p">((</span><span class="o">-</span><span class="n">sA</span><span class="o">*</span><span class="n">x7</span><span class="o">&gt;&gt;</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">x2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ci</span><span class="o">*</span><span class="p">(</span><span class="n">cj</span><span class="o">*</span><span class="n">sB</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">x5</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>

        <span class="kt">int</span> <span class="n">o</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">80</span> <span class="o">*</span> <span class="n">y</span><span class="p">;</span>
        <span class="kt">int8_t</span> <span class="n">zz</span> <span class="o">=</span> <span class="p">(</span><span class="n">x6</span><span class="o">-</span><span class="n">K2</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">15</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">22</span> <span class="o">&gt;</span> <span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="mi">80</span> <span class="o">&gt;</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">zz</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">[</span><span class="n">o</span><span class="p">])</span> <span class="p">{</span>
          <span class="n">z</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">zz</span><span class="p">;</span>
          <span class="n">b</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="s">".,-~:;=!*#$@"</span><span class="p">[</span><span class="n">N</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">N</span> <span class="o">:</span> <span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="n">R</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">si</span><span class="p">)</span>  <span class="c1">// rotate i</span>
      <span class="p">}</span>
      <span class="n">R</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">cj</span><span class="p">,</span> <span class="n">sj</span><span class="p">)</span>  <span class="c1">// rotate j</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="mi">1761</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
      <span class="n">putchar</span><span class="p">(</span><span class="n">k</span> <span class="o">%</span> <span class="mi">80</span> <span class="o">?</span> <span class="n">b</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">:</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">R</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">cA</span><span class="p">,</span> <span class="n">sA</span><span class="p">);</span>
    <span class="n">R</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">cB</span><span class="p">,</span> <span class="n">sB</span><span class="p">);</span>
    <span class="n">usleep</span><span class="p">(</span><span class="mi">15000</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\x1b</span><span class="s">[23A"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The output is pretty much the same.</p>

</article>







      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <a href="https://www.a1k0n.net/" class="site-title">a1k0n.net</a>
  </div>
</footer>



<div style="position: absolute; width: 0px; height: 0px; overflow: hidden; padding: 0px; border: 0px; margin: 0px;"><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-family: MathJax_Size1, sans-serif;"></div></div></body><grammarly-desktop-integration data-grammarly-shadow-root="true"></grammarly-desktop-integration></html>
